/* XDS v2.60: Copyright (c) 1999-2011 Excelsior, LLC. All Rights Reserved. */
/* "@(#)xruSTABS.c Feb  3 14:30:28 2012" */
/* Generated by XDS Modula-2 to ANSI C v4.20 translator */

#define X2C_int32
#define X2C_index32
#ifndef xruSTABS_H_
#include "xruSTABS.h"
#endif
#define xruSTABS_C_
#include "xPOSIX.h"







typedef FILE * FILE0;

static FILE0 MyExe;

static X2C_CARD32 StabSectionOffset;

static X2C_CARD32 StabSectionSize;

static X2C_CARD32 StabsNumber;

static X2C_CARD32 StabStrSectionOffset;

static X2C_CARD32 StabStrSectionSize;


extern X2C_CARD32 xruSTABS_GetStabsNumber(void)
{
   return StabsNumber;
} /* end GetStabsNumber() */


static void Init(void)
{
   MyExe = 0;
   StabSectionOffset = 0UL;
   StabSectionSize = 0UL;
   StabStrSectionOffset = 0UL;
   StabStrSectionSize = 0UL;
   StabsNumber = 0UL;
} /* end Init() */


static void Open(X2C_BOOLEAN * Error)
{
   MyExe = (FILE0)fopen("/proc/self/exe", "rb");
   if (MyExe==0) {
      *Error = 1;
      return;
   }
} /* end Open() */


static void Close(void)
{
   fclose(MyExe);
   MyExe = 0;
} /* end Close() */


static void Read(X2C_BOOLEAN * Error, X2C_LOC buff[], X2C_CARD32 buff_len,
                X2C_INT32 from, X2C_INT32 length)
{
   if (0!=fseek(MyExe, from, SEEK_SET)) {
      *Error = 1;
      return;
   }
   if (1U!=fread((X2C_ADDRESS)buff, (size_t)length, 1U, MyExe)) {
      *Error = 1;
      return;
   }
} /* end Read() */


static void ReadString(X2C_BOOLEAN * Error, X2C_INT32 OffsetInFile,
                X2C_CHAR name[], X2C_CARD32 name_len)
{
   if (0!=fseek(MyExe, OffsetInFile, SEEK_SET)) {
      *Error = 1;
      return;
   }
   fread((X2C_ADDRESS)name, name_len-1, 1U, MyExe);
   name[name_len-1] = 0;
} /* end ReadString() */


static void ParseFile(X2C_CARD32 * SHStrTabOffset,
                struct xruSTABS_ELF_HEADER * ELF_Header,
                X2C_BOOLEAN * Error)
{
   struct xruSTABS_SECTION_HEADER SectionHeader;
   X2C_CHAR sname[12];
   X2C_CARD16 i;
   X2C_CARD16 tmp;
   Read(Error, (X2C_LOC *)ELF_Header, sizeof(struct xruSTABS_ELF_HEADER)/1u,
                0L, 52L);
   if (*Error) return;
   if (((ELF_Header->e_type!=2U || ELF_Header->e_shentsize<40U)
                || ELF_Header->e_shoff==0UL) || ELF_Header->e_shstrndx==0U) {
      *Error = 1;
      return;
   }
   Read(Error, (X2C_LOC *) &SectionHeader,
                sizeof(struct xruSTABS_SECTION_HEADER)/1u,
                (X2C_INT32)(ELF_Header->e_shoff+(X2C_CARD32)
                (ELF_Header->e_shstrndx*ELF_Header->e_shentsize)), 40L);
   if (*Error) return;
   *SHStrTabOffset = SectionHeader.sh_offset;
   tmp = ELF_Header->e_shnum-1U;
   i = 1U;
   if (i<=tmp) for (;; i++) {
      Read(Error, (X2C_LOC *) &SectionHeader,
                sizeof(struct xruSTABS_SECTION_HEADER)/1u,
                (X2C_INT32)(ELF_Header->e_shoff+(X2C_CARD32)
                (i*ELF_Header->e_shentsize)), 40L);
      if (*Error) return;
      ReadString(Error, (X2C_INT32)(SectionHeader.sh_name+*SHStrTabOffset),
                sname, 12ul);
      if (*Error) return;
      if (X2C_STRCMP(sname,12u,".stab",6u)==0) {
         StabSectionOffset = SectionHeader.sh_offset;
         StabSectionSize = SectionHeader.sh_size;
         StabsNumber = StabSectionSize/12UL;
      }
      else if (X2C_STRCMP(sname,12u,".stabstr",9u)==0) {
         StabStrSectionOffset = SectionHeader.sh_offset;
         StabStrSectionSize = SectionHeader.sh_size;
      }
      if (i==tmp) break;
   } /* end for */
} /* end ParseFile() */


extern void xruSTABS_OpenMyExe(X2C_BOOLEAN * Error)
{
   struct xruSTABS_ELF_HEADER ELF_Header;
   X2C_CARD32 SHStrTabOffset;
   Init();
   *Error = 0;
   Open(Error);
   if (*Error) return;
   ParseFile(&SHStrTabOffset, &ELF_Header, Error);
   if (((((*Error || StabSectionOffset==0UL) || StabSectionSize==0UL)
                || StabStrSectionOffset==0UL) || StabStrSectionSize==0UL)
                || StabsNumber==0UL) {
      Close();
      *Error = 1;
      return;
   }
} /* end OpenMyExe() */


extern void xruSTABS_CloseMyExe(void)
{
   fclose(MyExe);
   Init();
} /* end CloseMyExe() */


extern void xruSTABS_GetStab(X2C_CARD32 stabstr_off, X2C_BOOLEAN * Error,
                X2C_CARD32 indx, struct xruSTABS_STAB * stab,
                X2C_CHAR name[], X2C_CARD32 name_len)
{
   Read(Error, (X2C_LOC *)stab, sizeof(struct xruSTABS_STAB)/1u,
                (X2C_INT32)(StabSectionOffset+indx*12UL), 12L);
   if (*Error) return;
   ReadString(Error, (X2C_INT32)(stabstr_off+StabStrSectionOffset+stab->n_strx),
                 name, name_len);
   if (*Error) return;
} /* end GetStab() */


extern void xruSTABS_BEGIN(void)
{
   static int xruSTABS_init = 0;
   if (xruSTABS_init) return;
   xruSTABS_init = 1;
   Init();
}

